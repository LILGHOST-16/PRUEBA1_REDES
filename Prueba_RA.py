import re
import ipaddress
import json
from datetime import datetime
import shutil
import sys

# Constantes
ARCHIVO = "Dispositivos_Guardados.json"
TIPOS_DISPOSITIVOS = ["switch", "router", "access point", "dispositivo final", "servidor", "cloud"]
CAPAS_RED = ["acceso", "distribuci√≥n", "n√∫cleo"]
SERVICIOS_DISPONIBLES = ["OSPF", "VLANs", "DHCP", "DNS", "NTP", "SSH", "SNMP", "Syslog"]

# Funciones de utilidad
def validar_ip(ip):
    """Valida si una cadena es una direcci√≥n IP v√°lida (IPv4 o IPv6)."""
    try:
        ipaddress.ip_address(ip)
        return True
    except ValueError:
        return False

def hacer_backup():
    """Crea un backup del archivo de datos con timestamp."""
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_file = f"{ARCHIVO}.backup_{timestamp}"
    try:
        shutil.copyfile(ARCHIVO, backup_file)
        print(f"‚úÖ Backup creado: {backup_file}")
        return True
    except Exception as e:
        print(f"‚ö†Ô∏è Error al crear backup: {e}")
        return False

def solicitar_input(mensaje, validacion=None, valor_por_defecto=None):
    """
    Solicita entrada al usuario con validaci√≥n opcional.
    
    Args:
        mensaje: El mensaje a mostrar al usuario
        validacion: Funci√≥n de validaci√≥n (retorna bool)
        valor_por_defecto: Valor a retornar si la entrada est√° vac√≠a
    
    Returns:
        La entrada validada del usuario
    """
    while True:
        dato = input(mensaje).strip()
        if not dato and valor_por_defecto is not None:
            return valor_por_defecto
        if not dato:
            print("‚ö†Ô∏è No puede estar vac√≠o. Intente de nuevo.")
            continue
        if validacion and not validacion(dato):
            print("‚ö†Ô∏è Dato inv√°lido. Intente de nuevo.")
            continue
        return dato

def seleccionar_servicios():
    """Permite al usuario seleccionar servicios de una lista predefinida."""
    print("\nüõ∞Ô∏è Seleccione los servicios habilitados en este dispositivo (s/n):")
    
    seleccionados = []
    for servicio in SERVICIOS_DISPONIBLES:
        while True:
            respuesta = input(f"¬ø{servicio}? (s/n): ").strip().lower()
            if respuesta in ['s', 'n', '']:  # Enter cuenta como 'no'
                break
            print("‚ö†Ô∏è Por favor ingrese 's' o 'n'")
        if respuesta == 's':
            seleccionados.append(servicio)
    return seleccionados

# Funciones de manejo de datos
def cargar_dispositivos():
    """Carga los dispositivos desde el archivo JSON."""
    try:
        with open(ARCHIVO, "r", encoding='utf-8') as f:
            try:
                return json.load(f)
            except json.JSONDecodeError:
                print("‚ö†Ô∏è El archivo de datos est√° corrupto. Se crear√° uno nuevo.")
                return []
    except FileNotFoundError:
        return []

def guardar_dispositivos(dispositivos):
    """Guarda la lista de dispositivos en el archivo JSON."""
    try:
        with open(ARCHIVO, "w", encoding='utf-8') as f:
            json.dump(dispositivos, f, indent=4, ensure_ascii=False)
        return True
    except IOError as e:
        print(f"‚ö†Ô∏è Error al guardar: {e}")
        return False

def guardar_dispositivo(dispositivo):
    """Agrega un nuevo dispositivo y guarda la lista actualizada."""
    dispositivos = cargar_dispositivos()
    dispositivos.append(dispositivo)
    return guardar_dispositivos(dispositivos)

# Funciones principales
def ingresar_dispositivo():
    """Registra un nuevo dispositivo en el sistema."""
    print("\n‚ûï Registro de Nuevo Dispositivo")

    nombre = solicitar_input("‚úèÔ∏è  Nombre: ")
    tipo = solicitar_input(
        "üîå Tipo (Switch, Router, Access Point, Dispositivo Final, Servidor, Cloud): ",
        lambda t: t.lower() in TIPOS_DISPOSITIVOS
    ).lower()
    ip = solicitar_input("üåê Direcci√≥n IP: ", validar_ip)
    ubicacion = solicitar_input("üìç Ubicaci√≥n F√≠sica: ")

    vlans = input("\nüì∂ Ingrese las VLANs configuradas: ").strip()
    servicios = seleccionar_servicios()
    capa = solicitar_input(
        "\nüì° Ingrese la capa de red (Acceso, Distribuci√≥n, N√∫cleo): ",
        lambda c: c.lower() in CAPAS_RED
    ).lower()

    dispositivo = {
        "Nombre": nombre,
        "Tipo": tipo,
        "IP": ip,
        "Ubicacion": ubicacion,
        "VLANs": vlans,
        "Servicios de Red": servicios,
        "Capa de Red": capa,
        "Fecha": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }

    if guardar_dispositivo(dispositivo):
        print("‚úÖ Dispositivo guardado exitosamente.\n")
    else:
        print("‚ùå Error al guardar el dispositivo.\n")

def buscar_dispositivo():
    """Busca dispositivos por diferentes criterios."""
    dispositivos = cargar_dispositivos()
    if not dispositivos:
        print("‚ö†Ô∏è No existen registros guardados.\n")
        return
    
    criterio = input("\nüîé Buscar dispositivo por Nombre, IP, Tipo o Ubicaci√≥n: ").strip().lower()
    
    encontrados = [
        d for d in dispositivos 
        if (criterio in d["Nombre"].lower() or 
            criterio in d["IP"].lower() or 
            criterio in d["Tipo"].lower() or 
            criterio in d["Ubicacion"].lower())
    ]
    
    if not encontrados:
        print("‚ùå No se encontraron coincidencias.\n")
        return
    
    print(f"\nüîç Se encontraron {len(encontrados)} dispositivos:")
    for i, d in enumerate(encontrados, 1):
        print(f"\nüìÑ Dispositivo {i}:")
        for clave, valor in d.items():
            print(f"  {clave}: {valor}")

def eliminar_dispositivo():
    """Elimina un dispositivo espec√≠fico."""
    dispositivos = cargar_dispositivos()
    if not dispositivos:
        print("‚ö†Ô∏è No existen registros guardados.\n")
        return
    
    criterio = input("\nüóëÔ∏è Ingrese el Nombre o IP del dispositivo a eliminar: ").strip().lower()
    original_count = len(dispositivos)
    dispositivos = [d for d in dispositivos if criterio not in d["Nombre"].lower() and criterio not in d["IP"]]
    
    if len(dispositivos) == original_count:
        print("‚ùå No se encontr√≥ ning√∫n dispositivo con ese criterio.\n")
        return
    
    if hacer_backup():
        if guardar_dispositivos(dispositivos):
            print(f"‚úÖ Se eliminaron {original_count - len(dispositivos)} dispositivos.\n")
        else:
            print("‚ùå Error al guardar los cambios.\n")

def editar_dispositivo():
    """Edita un dispositivo existente."""
    dispositivos = cargar_dispositivos()
    if not dispositivos:
        print("‚ö†Ô∏è No existen registros guardados.\n")
        return
    
    criterio = input("\nüìù Ingrese el Nombre o IP del dispositivo a editar: ").strip().lower()
    encontrados = [i for i, d in enumerate(dispositivos) 
                  if criterio in d["Nombre"].lower() or criterio in d["IP"]]
    
    if not encontrados:
        print("‚ùå No se encontr√≥ ning√∫n dispositivo con ese criterio.\n")
        return
    
    if len(encontrados) > 1:
        print("\n‚ö†Ô∏è Se encontraron m√∫ltiples dispositivos:")
        for idx in encontrados:
            print(f"  {dispositivos[idx]['Nombre']} - {dispositivos[idx]['IP']}")
        print("Por favor, sea m√°s espec√≠fico en su b√∫squeda.")
        return
    
    idx = encontrados[0]
    dispositivo = dispositivos[idx]
    
    print("\nüìÑ Dispositivo encontrado. Deje en blanco para mantener el valor actual.")
    
    # Edici√≥n gen√©rica para campos simples
    campos_editables = {
        "Nombre": None,
        "Tipo": lambda x: x.lower() in TIPOS_DISPOSITIVOS,
        "IP": validar_ip,
        "Ubicacion": None,
        "VLANs": None,
        "Capa de Red": lambda x: x.lower() in CAPAS_RED
    }
    
    for campo, validacion in campos_editables.items():
        while True:
            nuevo_valor = input(f"{campo} ({dispositivo[campo]}): ").strip()
            if not nuevo_valor:
                break
            if validacion and not validacion(nuevo_valor):
                print(f"‚ö†Ô∏è Valor inv√°lido para {campo}")
                continue
            dispositivo[campo] = nuevo_valor if campo != "Tipo" and campo != "Capa de Red" else nuevo_valor.lower()
            break
    
    if input("¬øActualizar servicios de red? (s/n): ").strip().lower() == 's':
        dispositivo["Servicios de Red"] = seleccionar_servicios()
    
    dispositivo["Fecha"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    if hacer_backup():
        if guardar_dispositivos(dispositivos):
            print("‚úÖ Dispositivo actualizado.\n")
        else:
            print("‚ùå Error al guardar los cambios.\n")

def limpiar_registros():
    """Elimina todos los registros de dispositivos."""
    confirmacion = input("\nüßπ ¬øEst√° seguro que desea eliminar TODOS los registros? (s/n): ").strip().lower()
    if confirmacion != 's':
        print("‚ùå Operaci√≥n cancelada.\n")
        return
    
    if hacer_backup():
        if guardar_dispositivos([]):
            print("‚úÖ Todos los registros fueron eliminados.\n")
        else:
            print("‚ùå Error al eliminar los registros.\n")

def generar_reporte():
    """Genera un reporte estad√≠stico detallado de los dispositivos."""
    dispositivos = cargar_dispositivos()
    if not dispositivos:
        print("‚ö†Ô∏è No existen registros guardados.\n")
        return
    
    print("\n" + "="*50)
    print("üìä REPORTE ESTAD√çSTICO DETALLADO".center(50))
    print("="*50)
    
    # 1. Resumen general
    print("\nüìå RESUMEN GENERAL")
    print(f"üìÖ Total de dispositivos registrados: {len(dispositivos)}")
    print(f"üìÖ √öltima actualizaci√≥n: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # 2. Conteo por tipo con detalles
    print("\nüî¢ DISTRIBUCI√ìN POR TIPO:")
    tipos = {}
    for d in dispositivos:
        tipos[d["Tipo"]] = tipos.get(d["Tipo"], 0) + 1
    
    for tipo, cantidad in sorted(tipos.items(), key=lambda x: x[1], reverse=True):
        print(f"\n  {tipo.upper()} ({cantidad} dispositivos):")
        for d in [d for d in dispositivos if d["Tipo"] == tipo][:3]:  # Muestra 3 ejemplos
            print(f"    - {d['Nombre']} ({d['IP']}) en {d['Ubicacion']}")
        if cantidad > 3:
            print(f"    ...y {cantidad-3} m√°s")
    
    # 3. Conteo por capa con detalles
    print("\nüì° DISTRIBUCI√ìN POR CAPA DE RED:")
    capas = {}
    for d in dispositivos:
        capas[d["Capa de Red"]] = capas.get(d["Capa de Red"], 0) + 1
    
    for capa, cantidad in sorted(capas.items(), key=lambda x: x[1], reverse=True):
        print(f"\n  {capa.upper()} ({cantidad} dispositivos):")
        for d in [d for d in dispositivos if d["Capa de Red"] == capa][:3]:
            print(f"    - {d['Nombre']} ({d['Tipo']}) con servicios: {', '.join(d['Servicios de Red'])}")
        if cantidad > 3:
            print(f"    ...y {cantidad-3} m√°s")
    
    # 4. Servicios m√°s comunes con dispositivos que los usan
    print("\nüõ†Ô∏è SERVICIOS M√ÅS UTILIZADOS:")
    servicios = {}
    for d in dispositivos:
        for servicio in d["Servicios de Red"]:
            servicios[servicio] = servicios.get(servicio, 0) + 1
    
    for servicio, cantidad in sorted(servicios.items(), key=lambda x: x[1], reverse=True):
        print(f"\n  {servicio} ({cantidad} dispositivos):")
        usuarios = [d for d in dispositivos if servicio in d["Servicios de Red"]]
        for d in usuarios[:3]:
            print(f"    - {d['Nombre']} ({d['IP']})")
        if cantidad > 3:
            print(f"    ...usado por {cantidad-3} dispositivos m√°s")
    
    # 5. Listado completo de dispositivos (resumido)
    print("\n" + "="*50)
    print("üìã LISTADO COMPLETO DE DISPOSITIVOS".center(50))
    print("="*50)
    
    for i, d in enumerate(dispositivos, 1):
        print(f"\nüîπ Dispositivo {i}: {d['Nombre'].upper()}")
        print(f"  üîå Tipo: {d['Tipo'].capitalize()}")
        print(f"  üåê IP: {d['IP']}")
        print(f"  üìç Ubicaci√≥n: {d['Ubicacion']}")
        print(f"  üì∂ VLANs: {d['VLANs']}")
        print(f"  üì° Capa: {d['Capa de Red'].capitalize()}")
        print(f"  üõ†Ô∏è Servicios: {', '.join(d['Servicios de Red']) or 'Ninguno'}")
        print(f"  üìÖ Registrado: {d['Fecha']}")
    
    print("\n" + "="*50)
    print(f"üéâ Reporte generado el {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("="*50 + "\n")

def salir():
    """Cierra la aplicaci√≥n."""
    print("\nüëã Cerrando el programa. ¬°Hasta Luego, Nos Vemos Pronto üòéüëç!")
    sys.exit(0)

def mostrar_menu():
    """Muestra el men√∫ principal con emojis y maneja las opciones."""
    opciones = {
        "1": ("üì≤ Ingresar Nuevo Dispositivo", ingresar_dispositivo),
        "2": ("üîç Buscar Dispositivo", buscar_dispositivo),
        "3": ("üìä Generar Reporte Estad√≠stico", generar_reporte),
        "4": ("‚úèÔ∏è  Editar Dispositivo", editar_dispositivo),
        "5": ("üóëÔ∏è  Eliminar Dispositivo", eliminar_dispositivo),
        "6": ("üßπ Limpiar Todos Los Registros", limpiar_registros),
        "7": ("üö™ Salir del Sistema", salir)
    }

    while True:
        print("\n" + "="*50)
        print("üìã MEN√ö PRINCIPAL".center(50))
        print("="*50)
        
        # Mostrar opciones con emojis y formato mejorado
        for key, (desc, _) in opciones.items():
            print(f"{key} {desc}")
        
        print("="*50)
        eleccion = input("\nüëâ Seleccione una opci√≥n (1-7): ").strip()
        
        if eleccion in opciones:
            print("\n" + "="*50)  # Separador visual antes de cada acci√≥n
            opciones[eleccion][1]()
        else:
            print("\n‚ö†Ô∏è Opci√≥n inv√°lida. Por favor ingrese un n√∫mero del 1 al 7.")
mostrar_menu()
    
